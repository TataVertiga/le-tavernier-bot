name: Check Kick Live & Notify Discord

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  kick_live_check:
    runs-on: ubuntu-latest

    steps:
      - name: Vérifie si TataVertiga est en live (avec logs)
        run: |
          echo "🔍 Récupération des infos depuis l'API Kick..."
          response=$(curl -s -w "%{http_code}" -A "Mozilla/5.0" https://kick.com/api/v1/channels/tatavertiga)
          http_code="${response: -3}"
          body="${response::${#response}-3}"

          echo "📡 HTTP Status Code: $http_code"
          echo "📄 Réponse JSON Kick:"
          echo "$body"

          if [ "$http_code" != "200" ]; then
            echo "❌ Échec de la requête Kick (code $http_code)"
            exit 1
          fi

          is_live=$(echo "$body" | grep -o '"livestream":null')

          if [ -z "$is_live" ]; then
            echo "✅ Tata est EN LIVE sur Kick ! Envoi du message..."

            curl -X POST "https://discord.com/api/v10/channels/1397681937082220687/messages" \
              -H "Authorization: Bot ${{ secrets.DISCORD_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{
                    "content": ":bell: Mortecouille bande de Gueux <@&881684792058466354> TataVertiga lance un live sauvage et ce n'est pas sorcellerie Messire... https://kick.com/tatavertiga"
                  }'
          else
            echo "🛌 Tata n'est pas en live."
          fi
